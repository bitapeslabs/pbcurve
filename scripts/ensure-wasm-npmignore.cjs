const fs = require("fs");
const path = require("path");

const root = path.join(__dirname, "..");
const targets = [
  path.join(root, "native", "pkg"),
  path.join(root, "native", "pkg-web"),
];

const fileContents =
  "# Autogenerated by pbcurve build – keeps wasm-pack artifacts intact.\n";

for (const dir of targets) {
  if (!fs.existsSync(dir)) {
    console.warn(
      `[pbcurve] Skipping .npmignore generation – missing directory: ${path.relative(
        root,
        dir
      )}`
    );
    continue;
  }

  const npmIgnorePath = path.join(dir, ".npmignore");
  try {
    const current = fs.existsSync(npmIgnorePath)
      ? fs.readFileSync(npmIgnorePath, "utf8")
      : null;
    if (current === fileContents) {
      continue;
    }
    fs.writeFileSync(npmIgnorePath, fileContents);
    console.log(
      `[pbcurve] Ensured ${path.relative(root, npmIgnorePath)} is in place.`
    );
  } catch (err) {
    console.warn(
      `[pbcurve] Failed to write ${path.relative(
        root,
        npmIgnorePath
      )}: ${err?.message || err}`
    );
  }
}
